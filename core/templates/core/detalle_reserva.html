{% extends 'core/base.html' %}

{% block css %}
<style>
    .metodo-pago-container h5 {
    font-weight: 600;
    color: #3a2a51;
    letter-spacing: 0.5px;
    }

    .metodo-card {
    background: #f8f6fb;
    border: 2px solid #d3c6e3;
    border-radius: 1rem;
    width: 170px;
    height: 95px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.25s ease-in-out;
    color: #4b226d;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
    user-select: none;
    }

    .metodo-card:hover {
    background: #ece4f5;
    border-color: #8c6bb1;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .metodo-card.active {
    background: linear-gradient(135deg, #5a2d82 0%, #8e5ccf 100%);
    color: white;
    border-color: #5a2d82;
    box-shadow: 0 6px 14px rgba(90, 45, 130, 0.4);
    }

    .metodo-card i {
    font-size: 2rem;
    margin-bottom: 0.4rem;
    }

    .metodo-card span {
    font-weight: 600;
    font-size: 0.95rem;
    }

    #btnEfectivo {
        background: linear-gradient(135deg, #5a2d82 0%, #8e5ccf 100%);
        color: #fff;
        font-weight: 600;
        border: none;
        transition: all 0.25s ease-in-out;
        box-shadow: 0 4px 8px rgba(90, 45, 130, 0.3);
    }

    #btnEfectivo:hover {
        background: linear-gradient(135deg, #4d2370 0%, #7a4fba 100%);
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(90, 45, 130, 0.4);
    }

    #btnEfectivo:active {
        transform: scale(0.98);
        box-shadow: 0 2px 6px rgba(90, 45, 130, 0.3);
    }
</style>

{% endblock css %}

{% block contenido %}
<!-- INICIO ENCABEZADO -->
<div class="">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-5 mt-5">
                <div class="intro-excerpt">
                    <h1 class="fw-bold text-center">PAGAR RESERVA</h1>
                </div>
            </div>
        </div>
    </div>
    <br><br><br>
</div>
<!-- FIN ENCABEZADO -->

<div class="bg-page">
    <br>
    <div class="container mt-4 shadow-lg">
        <div class="card">
            <div class="card-body shadow-lg">
                <!-- Detalles de la Reserva -->
                <h2 class="card-title fw-bold text-uppercase shadow-lg bg-purple text-white">Detalle de la Reserva</h2>
                <div class="table-responsive">
                    <table class="table table-bordered shadow-lg">
                        <tbody>
                            <tr>
                                <th style="width: 40%;">Fecha de Atención:</th>
                                <td>{{ agenda.fechaAtencion }}</td>
                            </tr>
                            <tr>
                                <th>Hora de Atención:</th>
                                <td>{{ agenda.horaAtencion }}</td>
                            </tr>
                            <tr>
                                <th>Tipo de Agenda:</th>
                                <td>{{ agenda.idServicio }}</td>
                            </tr>
                            <tr>
                                <th>Taller:</th>
                                <td>{{ agenda.idTaller }}</td>
                            </tr>
                            <tr>
                                <th>Patente Vehículo:</th>
                                <td>{{ agenda.idVehiculo }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Detalles del Reporte de Pago -->
                {% if reporte_pago %}
                    <h2 class="card-title mt-4 fw-bold text-uppercase shadow-lg bg-purple text-white">Detalle del Reporte de Pago</h2>
                    <div class="table-responsive ">
                        <table class="table table-bordered shadow-lg">
                            <tbody>
                                <tr>
                                    <th style="width: 40%;">Comentario:</th>
                                    <td>{{ reporte_pago.comentario }}</td>
                                </tr>
                                <tr>
                                    <th>Monto a pagar (CLP):</th>
                                    <td>${{ reporte_pago.monto|stringformat:".0f"|floatformat }}</td>
                                </tr>
                                {% if monto_dolares %}
                                <tr>
                                    <th>Monto a pagar (USD):</th>
                                    <td>${{ monto_dolares }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}

                <!-- Selector método de pago (diseño original, centrado) -->
                <div class="metodo-pago-container text-center mt-4 mb-4">
                    <h5 class="fw-bold mb-3 text-uppercase text-secondary">Selecciona tu método de pago</h5>

                    <div id="metodosPago" class="d-flex justify-content-center gap-3 flex-wrap">
                        {% for metodo in formas_pago %}
                        <div class="metodo-card {% if forloop.first %}active{% endif %}"
                            data-value="{{ metodo.nombreFormaPago|lower }}"
                            onclick="seleccionarMetodo(this)">
                            {% if metodo.nombreFormaPago|lower == 'paypal' %}
                            <i class="bi bi-paypal"></i>
                            {% elif metodo.nombreFormaPago|lower == 'efectivo' %}
                            <i class="bi bi-cash-coin"></i>
                            {% else %}
                            <i class="bi bi-credit-card"></i>
                            {% endif %}
                            <span>{{ metodo.nombreFormaPago }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>

            <!-- Contenedor de botones (mantenemos estructura original) -->
            <div class="text-center mt-3 mb-4">
                <!-- PayPal -->
                <div id="paypalContainer" class="">
                    <div id="btnPaypal"></div>
                </div>

                <!-- Efectivo -->
                <div id="efectivoContainer" class="d-none">
                    <button id="btnEfectivo" class="btn rounded-pill px-5 py-2 bg-purple">
                        PAGAR EN EFECTIVO
                    </button>
                </div>
            </div>

        </div>
    </div>
    <br><br><br><br><br><br>
</div>

{% endblock contenido %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.paypalobjects.com/api/checkout.js"></script>

<script>
    // --- Utilidad para obtener CSRF token (tu versión original) ---
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Render de PayPal (una sola vez para evitar bugs de doble render) ---
    var paypalRendered = false;
    function renderPaypalOnce() {
        if (paypalRendered) return;
        paypal.Button.render({
            env: 'sandbox',
            client: {
                sandbox: 'AUdczilLjDrMGcZtY3F9Xqa4WAmOmJQki8I3sWy9rTnnuxmiPWNOW1RACinASsIaWMDt8QPAbg0JQ1EL',
                production: 'demo_production_client_id'
            },
            locale: 'es_CL',
            style: {
                size: 'large',
                color: 'black',
                shape: 'rect'
            },
            commit: true,
            payment: function (data, actions) {
                return actions.payment.create({
                    transactions: [{
                        amount: { 
                            total: '{{ monto_dolares }}', 
                            currency: 'USD'
                        }
                    }]
                });
            },
            onAuthorize: function (data, actions) {
                return actions.payment.execute().then(function () {
                    pagoCompletado = true; // ✅ Marca que el pago fue exitoso
                    var csrftoken = getCookie('csrftoken');
                    $.ajaxSetup({
                        beforeSend: function(xhr, settings) {
                            xhr.setRequestHeader('X-CSRFToken', csrftoken);
                        }
                    });
                    $.ajax({
                        type: 'POST',
                        url: '{% url "actualizar_estado_agenda" agenda.idAgenda %}', 
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    title: '¡EL PAGO SE REALIZÓ CON ÉXITO!',
                                    text: 'El estado de su agenda ha sido actualizado a "Pagado".',
                                    icon: 'success',
                                    confirmButtonColor: '#3085d6',
                                    confirmButtonText: 'Confirmar'
                                }).then(function () {
                                    var link = document.createElement('a');
                                    link.href = '{% url "generar_documento_word" agenda.idAgenda %}';
                                    link.download = response.filename;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    window.location.href = '{% url "mis_reservas" %}';
                                });
                            } else {
                                Swal.fire('Error', 'No se pudo realizar el pago.', 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Error', 'ERROR EN LA SOLICITUD!', 'error');
                        }
                    });
                });
            },
            onCancel: function(data) {
                Swal.fire({
                    title: '¡CANCELADO!',
                    text: 'Transacción cancelada!',
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'Confirmar'
                });
            },
            onError: function(err) {
                // ✅ Solo mostrar error si no se marcó pagoCompletado
                if (!pagoCompletado) {
                    console.error(err);
                    Swal.fire({
                        title: 'Error',
                        text: 'Ha ocurrido un error con el pago',
                        icon: 'error',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Confirmar'
                    });
                }
            }
        }, '#btnPaypal');
        paypalRendered = true;
    }

    // --- Selector visual de método de pago ---
    function seleccionarMetodo(card) {
        // quitar activo de todos
        document.querySelectorAll(".metodo-card").forEach(c => c.classList.remove("active"));
        // activar el seleccionado
        card.classList.add("active");

        const metodo = card.getAttribute("data-value");

        // mostrar u ocultar secciones según método
        if (metodo === "efectivo") {
            $("#paypalContainer").addClass("d-none");
            $("#efectivoContainer").removeClass("d-none");
        } else {
            $("#efectivoContainer").addClass("d-none");
            $("#paypalContainer").removeClass("d-none");
            renderPaypalOnce(); // si vuelve a PayPal, lo vuelve a montar
        }
    }

    // --- Inicialización ---
    $(document).ready(function () {
        renderPaypalOnce(); // PayPal visible por defecto

        // activar el primero por defecto (normalmente PayPal)
        const firstCard = document.querySelector(".metodo-card");
        if (firstCard) firstCard.classList.add("active");

        // Pago en efectivo (flujo completo con generación de PDF)
        $('#btnEfectivo').on('click', function () {
            Swal.fire({
                title: 'Confirmar pago en efectivo',
                text: '¿Deseas registrar este pago y generar la boleta en PDF?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#5a2d82',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, generar'
            }).then((result) => {
                if (result.isConfirmed) {
                    var csrftoken = getCookie('csrftoken');
                    $.ajaxSetup({
                        beforeSend: function(xhr, settings) {
                            xhr.setRequestHeader('X-CSRFToken', csrftoken);
                        }
                    });
                    $.ajax({
                        type: 'POST',
                        url: '{% url "actualizar_estado_agenda" agenda.idAgenda %}',
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    title: 'Pago confirmado',
                                    text: 'Se ha registrado el pago en efectivo.',
                                    icon: 'success',
                                    confirmButtonColor: '#5a2d82',
                                    confirmButtonText: 'Descargar boleta'
                                }).then(() => {
                                    // Descargar boleta PDF
                                    window.location.href = '{% url "generar_boleta_pdf" agenda.idAgenda %}';
                                    setTimeout(() => {
                                        window.location.href = '{% url "mis_reservas" %}';
                                    }, 2000);
                                });
                            } else {
                                Swal.fire('Error', 'No se pudo registrar el pago.', 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Error', 'Ocurrió un problema con la solicitud.', 'error');
                        }
                    });
                }
            });
        });
    });
</script>

{% endblock js %}
