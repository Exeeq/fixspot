{% extends 'core/base.html' %}
{% load static %}

{% block css %}
<style>
  /* --- ESTILOS PERSONALIZADOS --- */

  .object-fit-cover { object-fit: cover; height: 100%; }

  .card-taller{
    background:#fff; border-radius:1.2rem; overflow:hidden;
    box-shadow:0 0.6rem 1.2rem rgba(0,0,0,.08);
    transition:transform .25s ease, box-shadow .25s ease;
  }
  .card-taller:hover{ transform:translateY(-6px); box-shadow:0 1rem 1.8rem rgba(0,0,0,.12); }

  /* Panel derecho */
  .card-taller .info{ padding:2rem 2.5rem; background-color:#2c2c2c; color:#f2f2f2; }
  .card-taller h3{ color:#bda4f0; font-weight:700; margin-bottom:1.2rem; }

  .card-taller ul{ padding-left:0; list-style:none; margin-bottom:1rem; }
  .card-taller li{ margin-bottom:.3rem; }
  .card-taller strong{ color:#fff; }

  /* Servicios */
  .badge-servicio{
    background-color:#efe6f7!important; color:#4b226d!important;
    border-radius:20px; font-size:.85rem; font-weight:500; padding:.4rem .9rem;
  }

  /* Calificación */
  .rating-stars{ display:flex; gap:8px; justify-content:flex-start; align-items:center; }
  .rating-stars i{ font-size:2rem; color:#ffca08; transition:color .3s; }
  .rating-stars i:hover{ color:#ffb400; }
  .rating-stars .inactive{ color:#ccc; }
  .calificacion-texto{ margin-left:10px; color:#bda4f0; font-size:1rem; }

  /* Botón destacado */
  .btn-agendar{
    background:linear-gradient(90deg,#8b5cf6 0%,#c084fc 100%);
    border:none; color:#fff; font-weight:600; letter-spacing:.4px;
    box-shadow:0 4px 10px rgba(139,92,246,.4); transition:all .3s ease;
  }
  .btn-agendar:hover{ background:linear-gradient(90deg,#9f7aea 0%,#d6bcfa 100%); transform:translateY(-2px); box-shadow:0 6px 15px rgba(139,92,246,.5); }
  .btn-agendar i{ margin-left:6px; }

  .text-muted.small{ font-size:.95rem; color:#d1d1d1!important; }

  /* Favoritos */
  .card-img-wrap{ position:relative; }
  .fav-btn{
    position:absolute; top:12px; right:12px; z-index:3;
    width:42px; height:42px; border-radius:999px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.45); border:0; color:#ffd54d;
    transition:.2s; cursor:pointer;
  }
  .fav-btn:hover{ transform:translateY(-1px); background:rgba(0,0,0,.6); }
  .fav-btn.inactive{ color:#e5e5e5; }
  .fav-btn .bi{ font-size:1.25rem; }
</style>
{% endblock css %}

{% block contenido %}
<!-- ENCABEZADO -->
<div class="py-5 text-center mb-5">
  <h1 class="fw-bold text-uppercase">Talleres</h1>
</div>

<!-- LISTADO DE TALLERES -->
<div class="bg-light py-5">
  <div class="container">
    {% for taller in talleres %}
    <div class="row align-items-center mb-5 card-taller">

      <!-- Imagen + estrella -->
      <div class="col-md-5 p-0 card-img-wrap">
        <img src="{{ taller.imagen.url }}" alt="{{ taller.nombreTaller }}"
             class="img-fluid w-100 h-100 object-fit-cover">

        <button class="fav-btn {% if not taller.es_favorito %}inactive{% endif %}"
                data-taller="{{ taller.idTaller }}"
                title="Marcar como favorito">
          {% if taller.es_favorito %}
            <i class="bi bi-star-fill"></i>
          {% else %}
            <i class="bi bi-star"></i>
          {% endif %}
        </button>
      </div>

      <!-- Información -->
      <div class="col-md-7 info">
        <h3>{{ taller.nombreTaller|upper }}</h3>

        <ul>
          <li><strong>Encargado:</strong> {{ taller.idUsuario.pnombre }} {{ taller.idUsuario.ap_paterno }}</li>
          <li><strong>Teléfono:</strong> {{ taller.telefono }}</li>
          <li><strong>Dirección:</strong> {{ taller.direccion }} {{ taller.idComuna.nombreComuna }}</li>
        </ul>

        {% if taller.descripcion %}
          <p class="text-muted small mb-3">{{ taller.descripcion }}</p>
        {% endif %}

        {% if taller.promedio_calificacion %}
          <div class="rating-stars">
            <i class="bi bi-star-fill"></i>
            <span class="calificacion-texto">Promedio de calificaciones: {{ taller.promedio_calificacion|floatformat:1 }}/5</span>
          </div>
        {% else %}
          <div class="rating-stars">
            <span class="text-muted small">Sin calificaciones aún</span>
          </div>
        {% endif %}

        {% with servicios=taller.tallerservicio_set.all %}
        {% if servicios %}
          <div class="mb-4">
            <strong class="d-block mb-2">Servicios ofrecidos:</strong>
            <div>
              {% for ts in servicios %}
              <span class="badge badge-servicio me-2 mb-2">
                {{ ts.idServicio.nombreServicio }}
                {% if ts.precio %}
                  <small class="text-secondary">(${% widthratio ts.precio 1 1 %})</small>
                {% endif %}
              </span>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        {% endwith %}

        <a href="{% url 'agendar_hora' taller.idTaller %}"
           class="btn btn-agendar rounded-pill px-4 py-2">
          Agendar ahora <i class="bi bi-calendar-check"></i>
        </a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // CSRF helper
  function getCookie(name){
    let v=null; if(document.cookie) for(const c of document.cookie.split(';')){
      const cc=c.trim(); if(cc.startsWith(name+'=')){ v=decodeURIComponent(cc.slice(name.length+1)); break; }
    } return v;
  }
  const csrftoken=getCookie('csrftoken');

  document.addEventListener('click', async (e)=>{
    const btn=e.target.closest('.fav-btn'); if(!btn) return;
    const tallerId=btn.dataset.taller;
    const activo=!btn.classList.contains('inactive');

    const res=await Swal.fire({
      title: activo?'¿Quitar de favoritos?':'¿Guardar como favorito?',
      text: activo?'Se eliminará de tus favoritos.':'Puedes marcar hasta 5 favoritos.',
      icon:'question', showCancelButton:true,
      confirmButtonText: activo?'Sí, quitar':'Sí, guardar',
      cancelButtonText:'Cancelar', reverseButtons:true
    });
    if(!res.isConfirmed) return;

    try{
      const r=await fetch("{% url 'toggle_favorito' %}",{
        method:'POST',
        headers:{'X-CSRFToken':csrftoken},
        body:new URLSearchParams({taller_id:tallerId})
      });
      const data=await r.json();

      if(!r.ok || !data.ok){
        Swal.fire('Ups', (data && data.msg) || 'No se pudo actualizar.', 'warning');
        return;
      }

      // Toggle visual
      btn.classList.toggle('inactive', !data.favorito);
      btn.innerHTML = data.favorito ? '<i class="bi bi-star-fill"></i>' : '<i class="bi bi-star"></i>';

      Swal.fire({
        toast:true, position:'top-end', timer:1600, showConfirmButton:false,
        icon:'success', title: data.favorito?'Agregado a favoritos':'Eliminado de favoritos'
      });
    }catch(err){
      Swal.fire('Error','Ocurrió un problema. Intenta nuevamente.','error');
    }
  });
</script>

<!-- libs que ya usabas -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
{% endblock js %}
