{% extends 'core/base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock css %}
{% block contenido %}
<!-- INICIO ENCABEZADO (no se toca) -->
<div class="">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-5 mt-5">
        <div class="intro-excerpt">
          <h1 class="fw-bold text-center text-uppercase">RESERVAS DEL TALLER</h1>
        </div>
      </div>
    </div>
  </div>
  <br><br><br>
</div>
<!-- FIN ENCABEZADO -->

<div class="bg-page">
  <br><br><br>

  {% if taller %}
  <div class="container">
    <h1 class="text-center fw-bold text-uppercase mb-4">RESERVAS: {{ taller.nombreTaller }}</h1>

    <!-- Toolbar filtros + botón Excel general -->
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <h5 class="mb-0 fw-semibold">Reservas</h5>

      <div class="d-flex align-items-center gap-2">
        <div class="btn-group me-2" id="filtros-estado" role="group" aria-label="Filtro por estado">
          <button type="button" class="btn btn-secondary text-white active" data-filtro="all" aria-pressed="true">
            <i class="bi bi-list-task me-1"></i> Todos
          </button>
          <button type="button" class="btn btn-light border-info text-info" data-filtro="1" aria-pressed="false">
            <i class="bi bi-gear-wide-connected me-1"></i> En proceso
          </button>
          <button type="button" class="btn btn-light border-warning text-warning" data-filtro="2" aria-pressed="false">
            <i class="bi bi-hourglass-split me-1"></i> Esperando pago
          </button>
          <button type="button" class="btn btn-light border-success text-success" data-filtro="3" aria-pressed="false">
            <i class="bi bi-cash-coin me-1"></i> Pagada
          </button>
        </div>

        {% if hay_pagadas %}
          <a href="{% url 'export_taller_pagadas_excel' taller.idTaller %}"
             class="btn btn-success rounded-pill">
            <i class="bi bi-file-earmark-spreadsheet me-1"></i> Excel (Pagadas)
          </a>
        {% else %}
          <button class="btn btn-outline-success rounded-pill" disabled>
            <i class="bi bi-file-earmark-spreadsheet me-1"></i> Excel (Pagadas)
          </button>
        {% endif %}
      </div>
    </div>

    <!-- Tabla -->
    <div class="card shadow-sm rounded-4">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle table-hover mb-0">
            <thead class="table-light">
              <tr class="text-uppercase small text-muted">
                <th>ID</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Servicio</th>
                <th>Cliente</th>
                <th>Patente</th>
                <th>Vehículo</th>
                <th class="text-center">Estado</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-reservas">
              {% for reserva in reservas %}
              <tr data-estado="{{ reserva.estado.idEstado }}">
                <td class="fw-semibold">#{{ reserva.idAgenda }}</td>
                <td>{{ reserva.fechaAtencion }}</td>
                <td>{{ reserva.horaAtencion }}</td>
                <td>{{ reserva.idServicio }}</td>
                <td>{{ reserva.cliente.pnombre }} {{ reserva.cliente.ap_paterno }}</td>
                <td><span class="badge text-bg-dark rounded-pill">{{ reserva.idVehiculo.patente }}</span></td>
                <td>
                  {{ reserva.idVehiculo.idMarca }} {{ reserva.idVehiculo.modelo }}
                  {% if reserva.idVehiculo.subModelo %} {{ reserva.idVehiculo.subModelo }}{% endif %}
                </td>
                <td class="text-center">
                  {% if reserva.estado.idEstado == 1 %}
                    <span class="badge text-bg-info px-3 py-2">
                      <i class="bi bi-gear-wide-connected me-1"></i> En proceso
                    </span>
                  {% elif reserva.estado.idEstado == 2 %}
                    <span class="badge text-bg-warning text-dark px-3 py-2">
                      <i class="bi bi-hourglass-split me-1"></i> Esperando pago
                    </span>
                  {% elif reserva.estado.idEstado == 3 %}
                    <span class="badge text-bg-success px-3 py-2">
                      <i class="bi bi-check2-circle me-1"></i> Pagada
                    </span>
                  {% else %}
                    <span class="badge text-bg-secondary px-3 py-2">
                      {{ reserva.estado.nombreEstado }}
                    </span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if reserva.estado.idEstado == 1 %}
                    <a href="{% url 'reporte_pago' reserva.idAgenda %}" class="btn btn-sm btn-outline-primary text-primary bg-white rounded-pill">
                      <i class="bi bi-receipt me-1"></i> Generar reporte de pago
                    </a>
                  {% elif reserva.estado.idEstado == 2 %}
                    <span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle px-3 py-2">
                        <i class="bi bi-hourglass-split me-1"></i> N/A
                    </span>
                  {% elif reserva.estado.idEstado == 3 %}
                    <a href="{% url 'generar_boleta_pdf' reserva.idAgenda %}" class="btn btn-sm btn-primary rounded-pill">
                      <i class="bi bi-file-earmark-arrow-down me-1"></i> Documento PDF
                    </a>
                  {% else %}
                    <a href="{% url 'reporte_pago' reserva.idAgenda %}" class="btn btn-sm btn-outline-primary text-primary bg-white rounded-pill">
                      <i class="bi bi-receipt me-1"></i> Generar reporte de pago
                    </a>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center py-5 text-muted">
                  No hay reservas registradas para este taller.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <br><br><br><br><br><br>
  </div>
  {% endif %}
</div>
{% endblock contenido %}

{% block js %}
{{ block.super }}
<script>
  (function () {
    const grupo = document.getElementById('filtros-estado');
    const tbody = document.getElementById('tabla-reservas');

    const styles = {
      all: { on: 'btn btn-secondary text-white',              off: 'btn btn-light border-secondary text-secondary' },
      '1': { on: 'btn btn-info text-white',                   off: 'btn btn-light border-info text-info'           },
      '2': { on: 'btn btn-warning text-dark',                 off: 'btn btn-light border-warning text-warning'     },
      '3': { on: 'btn btn-success text-white',                off: 'btn btn-light border-success text-success'     },
    };

    function ensureNoResultsRow() {
      let row = document.getElementById('no-results-row');
      if (!row) {
        row = document.createElement('tr');
        row.id = 'no-results-row';
        row.innerHTML = '<td colspan="9" class="text-center py-5 text-muted">No hay reservas para este filtro.</td>';
        row.style.display = 'none';
        tbody.appendChild(row);
      }
      return document.getElementById('no-results-row');
    }
    const noResultsRow = ensureNoResultsRow();

    function applyFilter(filtro) {
      Object.keys(styles).forEach(key => {
        const b = grupo.querySelector(`[data-filtro="${key}"]`);
        if (!b) return;
        b.className = (key === filtro) ? styles[key].on : styles[key].off;
        b.setAttribute('aria-pressed', key === filtro ? 'true' : 'false');
      });

      let visibles = 0;
      tbody.querySelectorAll('tr[data-estado]').forEach(tr => {
        const estado = String((tr.dataset.estado || '')).trim();
        const ok = (filtro === 'all') || (estado === filtro);
        tr.style.display = ok ? '' : 'none';
        if (ok) visibles++;
      });

      noResultsRow.style.display = visibles === 0 ? '' : 'none';
    }

    grupo.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-filtro]');
      if (!btn) return;
      applyFilter(String(btn.getAttribute('data-filtro')).trim());
    });

    applyFilter('all');
  })();
</script>
{% endblock js %}
